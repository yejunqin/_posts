---
title: 一个复杂需求的web打印解决方案
date: 2016-03-16 23:15:14
tags:
---

### 问题背景
之前做了一个物流打包页面的需求，这个页面提供打印包裹码和打印清单两种功能，但是在浏览器端每次只能调用一台打印机，因此这两个功能是独立分开的。上线使用后，收到反馈因为需要频繁切换打印机来打印包裹码和清单，用户觉得很繁琐，所以不愿意执行。
<!--more-->
### 以往的解决方案
以往解决方案是通过jqprint.js插件来调用浏览器的打印api，从而进行打印。但浏览器的打印功能比较弱，它有几个缺点：

 - 每次只能调用一台打印机；
 - 调用会弹出预览框；
 - 切换打印机后打印设置会重置（如边距，打印方向等）；

这些缺点在需要打印两种以上材料的时候就会体现出来。
流程就像这样：
![](http://7xnjm0.com1.z0.glb.clouddn.com/print5.png)

### 新的解决方案
通过本地安装控件[LODOP](http://www.lodop.net/) 连接浏览器与打印设备。lodop的功能十分强大，在这里介绍本次需求用到的特性：

 + 同时给多台设备发送打印命令；
 + 支持静默打印；
 + 获取打印设备、指定打印设备与纸张；
 + 可以输出多种条形码（这里用到了生成二维码）；

更多的高级特性可以参考官方文档。
#### 功能合并
将打印包裹码和清单合并为一个按钮，用户触发后分别渲染dom然后发送给lodop调用不同打印设备。并行任务流程：
![](http://7xnjm0.com1.z0.glb.clouddn.com/print1.png)
因为供应商使用统一的设备打印包裹码，所以可以直接指定设备直接打印，但是供应商打印清单的设备不尽相同，因此不能简单的直接指定设备。这里有两种办法：

 1. 打印清单时弹出预览窗口，让用户选择打印设备；
 2. 页面加载时获取打印设备列表，做成select元素让用户选择，触发任务时选择用户指定的设备；

显示第二种更加高效（因为可以静默打印）。
#### 新的问题
如果每次都让用户在select元素选择一次打印设备，也是不科学的。所以需要记下用户的选择。这里使用localStorage.

 1. 每次打印时储存更新用户选择的设备；
 ![](http://7xnjm0.com1.z0.glb.clouddn.com/print2.png)
 2. 页面加载时读取用户的选择；
 ![](http://7xnjm0.com1.z0.glb.clouddn.com/print3.png)

完善之后的流程：
![](http://7xnjm0.com1.z0.glb.clouddn.com/print4.png)

用户只需点击一次按钮打印包裹码及清单，用户只需选择一次设备即可不需预览而直接打印。

### 总结
使用lodop有以下优点：

 - 支持多设备打印；
 - 支持静默打印；
 - 边距、样式控制精度高；
 - 可输出多种条形码；
 - 对浏览器兼容性高；
 
还有一些没有用到的特性没有列举；

总之，如果在web端有较复杂的打印需求，lodop是一个不错的解决方案。
缺点是需要在本地安装控件及免费版有水印。

